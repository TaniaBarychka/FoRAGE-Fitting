---
title: "Forage Fitting"
author: "Tania Barychka"
date: "17/01/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

**Summary from data exploration**

1. Possible outliers in covariates and responses except for the Temperature.
2. Signs of collenarity between prey and predator body masses.
3. Relationships:
- Handling times increases with prey body mass particucarly for invertebrates and vertebrates. Not as clear for protozoans.
Handling time increases more clearly with Prey/Predator bosy mass and slope looks more similar between groups.
No clear relationship with predator body mass.
- Attack rates increase with both prey and predator body masses.
- No clear relationships with temperature.
4.  No significant interactions with temperature only. Some signs of interactions when broken into groups.


I will start with simple models with no interactions.

Consider residuals.

Consider interaction with temperature.

Apply the model, model selection, model validation. If the validation shows that there are patterns in the residuals, I will investigate why. Adding interactions may be an option to improve the model.

```{r echo=FALSE, warning=FALSE, message=FALSE}

library (ggplot2)
library(dplyr)          # for data manipulation
library(tidyr)          # for data shaping
library(ggpubr)
library(gridExtra)
library(car)
library(lattice)

#install.packages("devtools")
#devtools::install_github("cardiomoon/ggiraphExtra")
require(ggiraph)
require(ggiraphExtra)
#require(plyr)


#work desktop
#source("C:/Users/Tania Barychka/OneDrive/Desktop/HighstatLibV10.R")

#home desktop
source("C:/Users/Etherian/OneDrive/Desktop/HighstatLibV10.R")


#small laptop
#source("C:/Users/tatsi/OneDrive/Desktop/HighstatLibV10.R")

# Create customized color palette
library(RColorBrewer)
mycol = c(brewer.pal(name="Dark2", n = 8), brewer.pal(name="Paired", n = 6))
```



```{r echo=FALSE}
#work
#forage_db<- read.csv("C:/Users/Tania Barychka/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

#summary(forage_db)




#home
forage_db<- read.csv("C:/Users/Etherian/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

#laptop
#forage_db<- read.csv("C:/Users/Tania/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

#small laptop
#forage_db<- read.csv("C:/Users/tatsi/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

forage_db<-forage_db[-c(2084:2682),]
```


```{r echo=FALSE}

#####NOTICE: THIS IS IN MG, NEED TO CONVERT TO G FOR COMPARISON WITH MADINGKEY AND PARAMETERISATION##

#reduce data set to the variables we're interested in. 
forage_db$L.PredBM<-log10(forage_db$Predator.mass..mg.)
forage_db$L.PreyBM<-log10(forage_db$Prey.mass..mg.)
forage_db$L.Fitted.a..median.of.BS.samples.<-log10(forage_db$Fitted.a..median.of.BS.samples.)
forage_db$L.Fittted.h..day.<-log10(forage_db$Fittted.h..day.)

#add ecto and endotherms
forage_db$EctoEndo<-ifelse(forage_db$Major.grouping.1=="Bird" | forage_db$Major.grouping.1=="Mammal", "Endo", "Ecto" )

#I'll remove angiosperms, protozoans and Nas.

forage_db<-forage_db[forage_db$Vert.invert!="" & forage_db$Vert.invert!="Angiosperm" ,]
table(forage_db$Vert.invert)
#& forage_db$Vert.invert!="Protozoan"

table(forage_db$EctoEndo, forage_db$Major.grouping.1)

```


```{r eval=FALSE, echo=FALSE}


df<-cbind(forage_db$L.PredBM, forage_db$L.PreyBM, forage_db$L.Fitted.a..median.of.BS.samples., forage_db$L.Fittted.h..day., forage_db$Temp..C.., forage_db$EctoEndo)

colnames(df)<-c("LogPredBM", "LogPreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c", "EctoEndo")

df<-as.data.frame(df)

df$VertInvert<-forage_db$Vert.invert


df_no<-df[df$VertInvert!="" & df$VertInvert!="Angiosperm",]
table(df_no$VertInvert, df_no$EctoEndo)

```



A. Attack rate
--


```{r}

#Attack rate ~ Predator body mass
ar1_pred<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM)
summary(ar1_pred)
anova(ar1_pred)

#Attack rate ~Prey body mass
ar1_prey<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PreyBM)
summary(ar1_prey)
anova(ar1_prey)

#Attack rate ~Prey and Pred Body mass
ar1_preyPred<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM+forage_db$L.PreyBM)
summary(ar1_preyPred)
anova(ar1_preyPred)

#run a drop test
drop1(ar1_preyPred, test="F")
```

AIC and the residual sum of squares of the model with prey body mass is just slightly smaller. Will keep prey body mass for now.

Let's look at potential interaction with temperature.


```{r}
ar1_preyPredTemp<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM+forage_db$L.PreyBM+forage_db$Temp..C..)
summary(ar1_preyPredTemp)
anova(ar1_preyPredTemp)
drop1(ar1_preyPredTemp)

#Fit a model with predator BM and compare
#ar1_predTemp<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM+forage_db$Temp..C..)
#anova(ar1_preyPredTemp, ar1_predTemp)

```

*Model Selection*

```{r}

step(ar1_preyPredTemp)
```

Sadly, I cant compare models directly as the number of non-na datapoints vary between cases.

```{r}

df<-cbind(as.numeric(forage_db$L.PredBM), as.numeric(forage_db$L.PreyBM), as.numeric(forage_db$L.Fitted.a..median.of.BS.samples.), as.numeric(forage_db$L.Fittted.h..day.), as.numeric(forage_db$Temp..C..))

#colnames(df)<-c("LogPredBM", "LogPreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c")
colnames(df)<-c("L.PredBM", "L.PreyBM", "L.Fitted.a..median.of.BS.samples.", "L.Fittted.h..day.", "Temp..C..")


df<-as.data.frame(df)

df$VertInvert<-forage_db$Vert.invert
df$EctoEndo<-forage_db$EctoEndo


df_no<-df[df$VertInvert!="" & df$VertInvert!="Angiosperm",]
table(df_no$VertInvert, df_no$EctoEndo)

df_na<-na.omit(df_no)

ar1_preyPredTemp_na<-lm(df_na$L.Fitted.a..median.of.BS.samples.~df_na$L.PredBM+df_na$L.PreyBM+df_na$Temp..C..)

step(ar1_preyPredTemp_na)

#Optimal: AR~Predator BM + Temp
ar1_opt_f<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM+forage_db$Temp..C..)

summary(ar1_opt_f)
anova(ar1_opt_f)

```

It looks like the model with Predator body mass and temperature is very marginally better than the full model (Prey and predator body mass and temp) withou Nas removed. 

Step selection (with Na's removed from dataset) suggest that that full model is very slightly better (AIC of 909.32) compared to the model without Prey biomass (AIC = 910.54). Removal of temperature and predator biomass increase AICs to 1026.64 and 1803.60, respectively.


*Model Validation*

I'm going to proceed with predator body mass and temperature only.

1. Plot (standardised) residuals against fitted values to assess homogeneity.
2. Make a histogram of teh residuals to verify normality. Can also use QQ-plot.
3. Plot the residuals against each  explanatory variable. If there is a pattern, we're violating the independence assumption.
Plot the residuals against prey bodymass (not used in the model). If there is a patter, include prey body mass and refit the model. If the residuals patterms disappear, include prey body mass (even of not significant)
4. Assess the model for influential observations. A useful tool is the Cook distance function.


```{r fig.height=10, fig.width=10}

ar1_opt<-lm(df_na$L.Fitted.a..median.of.BS.samples.~df_na$L.PredBM+df_na$Temp..C..)

op<-par(mfrow=c(2,2))



#win.graph();
op<-par(mfrow=c(2,2))
#Check for normality
E<-rstandard(ar1_opt)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=df_na$L.PredBM, xlab="log10 Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na$Temp..C.., xlab="Temp, C", ylab="Residuals")
abline(0,0)

#Residuals against Prey Bodymass
plot(E~df_na$L.PreyBM, xlab="Prey bodymass", ylab="Residuals")
abline(0,0)
par(op)
```

1. There is some evidence of non-constant variance as points are clustered in the middle, and of uniform errors (S-shaped pattern in QQ plot: the fit in the centre is fine, but the largest and the smallest residuals are too small).

2. A bit of clustering for fitted values vs square root of standardised residuals. But not too bad.

3. We have three influential points that need investigating: 172; 374 (?) and 375 (?).We will leave them out and refit the model (p402); check the new slope and the standard error on the slope.

4. I can't see a strong pattern in residuals vs explanatory variables plot including prey bodymass. I'm going to leave it out for now.

*As errors are unform, we may need to fit a different model to the data.* Spoke to Tim and he felt that test looked alright, no big issues.



```{r echo=FALSE, eval=FALSE}

m1<-lm(LogFittedAR~LogPreyBM+LogPredBM+Temp_c, data=df_no)
summary(m1)

drop1(m1,test="F")

anova(m1)

step(m1)

```


**Interaction Models**

```{r}

ar2_PredTempE<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+Temp..C..*as.factor(EctoEndo), data=forage_db)
summary(ar2_PredTempE)
anova(ar2_PredTempE)

drop1(ar2_PredTempE)

step(ar2_PredTempE)

```

Predator Body mass and temperature still highly significant on their own. Ecto and Endotherm are not significant on their own but are significant at 5% as an inetraction with temperature.

AIC of the full model is very marginally smaller (1198.6) than the model with the interaction between temperature and Ecto/Endo (1202.4) 

How do models with and without Temperature- Ecto/Endo interaction compare?


```{r}

ar1_opt_na<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+df_na$Temp..C.., data=df_na)
summary(ar1_opt_na)

ar2_PredTempE_na<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+df_na$Temp..C..*as.factor(EctoEndo), data=df_na)
summary(ar1_opt_na)

anova(ar1_opt_na, ar2_PredTempE_na)
```

Comparing models using anova suggests including the interaction term led to significantly (<.001) improved fit. Two addtional parameters are estimated in more complex model.

Let's do **model validation** again.


```{r echo=FALSE}
op<-par(mfrow=c(2,2))

plot(ar2_PredTempE_na)


#win.graph();

#Check for normality
E<-rstandard(ar2_PredTempE_na)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=df_na$L.PredBM, xlab="log10 Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na$Temp..C.., xlab="Temp, C", ylab="Residuals")
abline(0,0)

#Residuals against Prey Bodymass
plot(E~df_na$L.PreyBM, xlab="Prey bodymass", ylab="Residuals")
abline(0,0)
par(op)
```


Model validation for the model with inetraction term looks about the same as the model without the interaction term: no serious issues.


**Predictions**

*Without Temperature and Ecto/Endotherms Interaction*

```{r fig.height=10, fig.width=10}

newLpredBM=df_na$L.PredBM
newTemp=df_na$Temp..C..

newdata<-data.frame(newLpredBM=df_na$L.PredBM,newTemp=df_na$Temp..C..)


ar1_opt_na=lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+Temp..C.., data=df_na)
summary(ar1_opt_na)

```

```{r fig.height=10, fig.width=10, echo=FALSE}

#pred<-predict.lm(ar1_opt_na, newdata)
#plot(L.PredBM, L.Fitted.a..median.of.BS.samples., data=)
#points(pred, df_na$L.PredBM, col="blue")


#ggplot(df_na, aes(df_na$L.PredBM,df_na$L.Fitted.a..median.of.BS.samples., colour=df_na$Temp..C..))+geom_point()+stat_smooth(method="lm", se=FALSE)


ggPredict(ar1_opt_na, interactive = TRUE)


```

The model without interaction: 

**Log10(Attack Rate)=0.85x+(-4.11+0.05 per 1 degree C), where x=Log10 Predator Body mass**


*With Temperature and Ecto/Endotherms Interaction*


```{r fig.height=10, fig.width=10}

newLpredBM=df_na$L.PredBM
newTemp=df_na$Temp..C..
newEE=df_na$EctoEndo

newdata<-data.frame(newLpredBM=df_na$L.PredBM,newTemp=df_na$Temp..C.., newEE=df_na$EctoEndo)

ar2_opt_na=lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+Temp..C..*EctoEndo, data=df_na)
summary(ar2_opt_na)

```

```{r fig.height=10, fig.width=10, echo=FALSE}

#pred<-predict.lm(ar1_opt_na, newdata)
#plot(L.PredBM, L.Fitted.a..median.of.BS.samples., data=)
#points(pred, df_na$L.PredBM, col="blue")


#ggplot(df_na, aes(df_na$L.PredBM,df_na$L.Fitted.a..median.of.BS.samples., colour=df_na$Temp..C..))+geom_point()+stat_smooth(method="lm", se=FALSE)


ggPredict(ar2_opt_na, interactive = TRUE)


```

Two separate models: 

**Ectotherms: Log10 AR = 0.81 x + (-3.77+0.04 per 1 degree C )**

**Endotherms: Log10 AR = 0.81 x + (-5.87+0.15 per 1 degree C)**



B. Handling time
--


```{r echo=FALSE, eval=FALSE}

#Handling time ~ Predator Body mass+Prey Body Mass+Temp_c

m2<-lm(LogFittedH_day~LogPreyBM+LogPredBM+Temp_c, data=df_no)
summary(m2)

drop1(m2,test="F")

anova(m2)

```



```{r echo=FALSE, eval=FALSE}
#Handling time ~ Prey/Predator body mass+Temp

m3<-lm(log10(Fittted.h..day.)~log10(Prey.mass..mg./Predator.mass..mg.)+Temp..C.., data=forage_db)
summary(m3)

drop1(m3,test="F")

anova(m3)

anova(m2,m3)
```


```{r}

#prey
ht1_prey<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM)
summary(ht1_prey)
anova(ht1_prey)

#predator
ht1_pred<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PredBM)
summary(ht1_pred)
anova(ht1_pred)

#prey/predator
ht1_preyOverpred<-lm(log10(Fittted.h..day.)~log10(Prey.mass..mg./Predator.mass..mg.), data=forage_db)
summary(ht1_preyOverpred)
anova(ht1_preyOverpred)

#prey and pred
ht1_preyPred<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM+forage_db$L.PredBM)
summary(ht1_preyPred)
anova(ht1_preyPred)

drop1(ht1_preyPred)

```

The model with both predator and prey biomass has the lowest AIC score.

```{r}
#prey, pred and temp
ht1_preyPredTemp<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM+forage_db$L.PredBM+forage_db$Temp..C..)
summary(ht1_preyPredTemp)
anova(ht1_preyPredTemp)
drop1(ht1_preyPredTemp)

#prey/pred+Temp
ht1_preyOverpredTemp<-lm(log10(Fittted.h..day.)~log10(Prey.mass..mg./Predator.mass..mg.)+forage_db$Temp..C.., data=forage_db)
summary(ht1_preyOverpredTemp)
anova(ht1_preyOverpredTemp)

drop1(ht1_preyOverpredTemp)

#anova(ht1_preyPred,ht1_preyPredTemp)

#prey, Temp, pred
ht1_preyTempPred<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM+forage_db$Temp..C..+forage_db$L.PredBM)
summary(ht1_preyTempPred)
```

At the moment, both predator and prey body mass are significant.The best model is harvest rate~prey/predator bodymass.

Temperature is not significant on its own. Perhaps as an interaction term? 

I'll also have a look at Ecto Endo grouping.

**Model validation**

```{r echo=FALSE}

df_hr<-cbind(as.numeric(forage_db$Predator.mass..mg.), as.numeric(forage_db$Prey.mass..mg.), as.numeric(forage_db$L.Fitted.a..median.of.BS.samples.), as.numeric(forage_db$L.Fittted.h..day.), as.numeric(forage_db$Temp..C..))

colnames(df_hr)<-c("PredBM", "PreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c")

df_hr<-as.data.frame(df_hr)

df_hr$VertInvert<-forage_db$Vert.invert
df_hr$EctoEndo<-forage_db$EctoEndo


df_no_hr<-df_hr[df_hr$VertInvert!="" & df_hr$VertInvert!="Angiosperm",]
table(df_no_hr$VertInvert, df_no_hr$EctoEndo)

df_na_hr<-na.omit(df_no_hr)

df_na_hr$LogPredBM<-log10(df_na_hr$PredBM)
df_na_hr$LogPreyBM<-log10(df_na_hr$PreyBM)

```






```{r fig.height=10, fig.width=10}

hr1_opt<-lm(df_na_hr$LogFittedH_day~log10(df_na_hr$PreyBM/df_na_hr$PredBM))
op<-par(mfrow=c(2,2))

plot(hr1_opt)


#win.graph();
op<-par(mfrow=c(2,2))
#Check for normality
E<-rstandard(hr1_opt)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=log10(df_na_hr$PreyBM/df_na_hr$PredBM), xlab="log10 Prey/Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na_hr$Temp_c, xlab="Temp, C", ylab="Residuals")
abline(0,0)

#Residuals against Prey Bodymass
plot(E~log10(df_na_hr$PreyBM), xlab="Prey bodymass", ylab="Residuals")
abline(0,0)


#Residuals against predator bodymass
plot(E~log10(df_na_hr$PredBM), xlab="Predator bodymass", ylab="Residuals")
abline(0,0)

plot(E~as.factor(df_na_hr$EctoEndo), ylab="Residuals")
par(op)

```


Some serious problems with the fits: missed variance structure or an explanatory variable.


**Preditor + Prey model**


```{r}

df<-cbind(as.numeric(forage_db$L.PredBM), as.numeric(forage_db$L.PreyBM), as.numeric(forage_db$L.Fitted.a..median.of.BS.samples.), as.numeric(forage_db$L.Fittted.h..day.), as.numeric(forage_db$Temp..C..))

#colnames(df)<-c("LogPredBM", "LogPreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c")
colnames(df)<-c("L.PredBM", "L.PreyBM", "L.Fitted.a..median.of.BS.samples.", "L.Fittted.h..day.", "Temp..C..")


df<-as.data.frame(df)

df$VertInvert<-forage_db$Vert.invert
df$EctoEndo<-forage_db$EctoEndo


df_no<-df[df$VertInvert!="" & df$VertInvert!="Angiosperm",]
table(df_no$VertInvert, df_no$EctoEndo)

df_na<-na.omit(df_no)

hr1_PrPrey<-lm(df_na$L.Fittted.h..day.~df_na$L.PreyBM+df_na$L.PredBM)
summary(hr1_PrPrey)
step(hr1_PrPrey)


##VALIDATION
plot(hr1_PrPrey)


#win.graph();
op<-par(mfrow=c(2,2))
#Check for normality
E<-rstandard(hr1_PrPrey)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=df_na$L.PreyBM, xlab="log10 Prey bodymass", ylab="Residuals")
abline(0,0)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=df_na$L.PredBM, xlab="log10 Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na$Temp..C., xlab="Temp, C", ylab="Residuals")
abline(0,0)

#Residuals against Prey Bodymass
plot(E~log10(df_na_hr$PreyBM), xlab="Prey bodymass", ylab="Residuals")
abline(0,0)

par(op)


```







Let me compare pred+prey vs pred+prey+temp:

```{r echo=FALSE}



hr1_na_PreyPred<-lm(LogFittedH_day~df_na_hr$LogPreyBM+df_na_hr$LogPredBM, data=df_na_hr)
summary(hr1_na_PreyPred)

hr1_na_PreyPredTemp<-lm(LogFittedH_day~df_na_hr$LogPreyBM+df_na_hr$LogPredBM+df_na_hr$Temp_c,data=df_na_hr)
summary(hr1_na_PreyPredTemp)


anova(hr1_na_PreyPredTemp, hr1_na_PreyPred)

hr1_na_PreyPredEcEn<-lm(LogFittedH_day~df_na_hr$LogPreyBM+df_na_hr$LogPredBM+as.factor(df_na_hr$EctoEndo),data=df_na_hr)
summary(hr1_na_PreyPredEcEn)

anova(hr1_na_PreyPredEcEn,hr1_na_PreyPred)

inHr_na<-lm(LogFittedH_day~df_na_hr$LogPreyBM+df_na_hr$LogPredBM+df_na_hr$Temp_c*df_na_hr$EctoEndo, data = df_na_hr)
summary(inHr_na)

```

- Temperature is NOT significant.

- Ecto and Endotherms are not significant.

- Ecto/Endo*Temp interaction is not significant. 


**Model Validation 2**

```{r fig.height=10, fig.width=10,echo=FALSE}

hr1_opt_2<-lm(df_na_hr$LogFittedH_day~df_na_hr$LogPreyBM+df_na_hr$LogPredBM)
op<-par(mfrow=c(2,2))

plot(hr1_opt_2)


#win.graph();
op<-par(mfrow=c(2,2))
#Check for normality
E<-rstandard(hr1_opt_2)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=log10(df_na_hr$PreyBM), xlab="log10 Prey bodymass", ylab="Residuals")
abline(0,0)

plot(y=E, x=log10(df_na_hr$PredBM), xlab="log10 Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na_hr$Temp_c, xlab="Temp, C", ylab="Residuals")
abline(0,0)

plot(E~as.factor(df_na_hr$EctoEndo), ylab="Residuals")
par(op)

```

Problematic plots again. 

```{r}

hr1_PreyPredTempInter<-lm(L.Fittted.h..day.~L.PreyBM*L.PredBM*Temp..C.., data=forage_db)
summary(hr1_PreyPredTempInter)


```


Prey and Predator body mass inetraction is significant and so is three-way interaction with Temperature.

Let's remove some terms.


```{r}

hr1_PreyPredTempInter2<-update(hr1_PreyPredTempInter,~.-Temp..C..)
summary(hr1_PreyPredTempInter2)

#Now lets remove the least significant interaction term: PreyBM: Temp
hr1_PreyPredTempInter3<-update(hr1_PreyPredTempInter2,~.-L.PreyBM:Temp..C..)
summary(hr1_PreyPredTempInter3)

#All the terms are significant. Let's check the assumptions:
par(mfrow=c(2,2))
plot(hr1_PreyPredTempInter3)

```

We have problems with residuals and non-normality. 

I'm going to remove some problematic values: 1451, 2011, 859, 796 and 2047.


```{r echo=FALSE}

#forage_db[2011,]

forage_db_sub<-forage_db[-c(1449, 2009,857,794, 2045),]

hr1_PreyPredTempInter4<-lm(L.Fittted.h..day. ~ L.PreyBM + L.PredBM + L.PreyBM:L.PredBM + L.PredBM:Temp..C.. + L.PreyBM:L.PredBM:Temp..C.., data=forage_db_sub)
par(mfrow=c(2,2))
plot(hr1_PreyPredTempInter4)

```


I'm going to remove  aquatics (==all protozoans).

```{r echo=FALSE}

#I'll remove angiosperms, protozoans and Nas.

forage_db_reduced<-forage_db[forage_db$Habitat!="Aquatic",]
table(forage_db_reduced$Vert.invert)

#& forage_db$Vert.invert!="Protozoan" 

#all protozoans are aquatic

#refit
hr1_Inter_R<-lm(L.Fittted.h..day.~L.PreyBM+L.PredBM, data=forage_db_reduced)
summary(hr1_Inter_R)
op<-par(mfrow=c(2,2))
plot(hr1_Inter_R)


#win.graph();

#Check for normality
E<-rstandard(hr1_Inter_R)

hist(E)
qqnorm(E)

```



```{r echo=FALSE, eval=FALSE}

#Let's try fitting predator first.
hr1_opt_2Pred<-lm(df_na_hr$LogFittedH_day~df_na_hr$LogPredBM+df_na_hr$LogPreyBM)
summary(hr1_opt_2Pred)

op<-par(mfrow=c(2,2))

plot(hr1_opt_2Pred)


#win.graph();
op<-par(mfrow=c(2,2))
#Check for normality
E<-rstandard(hr1_opt_2Pred)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=log10(df_na_hr$PreyBM), xlab="log10 Prey bodymass", ylab="Residuals")
abline(0,0)

plot(y=E, x=log10(df_na_hr$PredBM), xlab="log10 Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na_hr$Temp_c, xlab="Temp, C", ylab="Residuals")
abline(0,0)

plot(E~as.factor(df_na_hr$EctoEndo), ylab="Residuals")
par(op)

#No difference, still looks bad.

```




**Residuals as function of ectotherms and endotherms:**

```{r echo=FALSE}

par(mfrow=c(1,2))


xyplot(E~Temp_c,groups=df_na_hr$EctoEndo, data = df_na_hr,auto.key = list(corner = c(0, .98)), cex = 1,xlab="Temp, C", ylab="Residuals",panel = function(x, y, ...){
        
          panel.xyplot(x,y, ...)
          panel.abline(h=0,lty=1,lwd=1)
        })


```


It's not obvious that residuals for endotherms are separate from ecotherms's residuals.

A few alternative models:

HT~ Prey BM+Pred BM+Ecto/Endo

```{r}

ht1_preyPredEE<-lm(L.Fittted.h..day.~L.PreyBM+L.PredBM+factor(EctoEndo), data=forage_db)
summary(ht1_preyPredEE)
anova(ht1_preyPredEE)
drop1(ht1_preyPredEE)

```


HT~PreyBM+PredBM+Temp*Ecto/Endo

```{r}
ht2_preyPredEETemp<-lm(L.Fittted.h..day.~L.PreyBM+L.PredBM+Temp..C..*as.factor(EctoEndo), data=forage_db)
summary(ht2_preyPredEETemp)
anova(ht2_preyPredEETemp)
drop1(ht2_preyPredEETemp)
```





None of the alternative models look to improve significantly upon the basic prey and predator body mass model. 

I wonder if collinearity between the body masses are too confusing here. Check tomorrow. Other idea is to fit prey/pred with endo ecto...



```{r}

#lets look at the reduced dataset first

pairs(df_na_hr[,c(-1,-2,-3,-6,-7)], panel = panel.smooth)

df_na_hr$LogPredBM<-log10(df_na_hr$PredBM)
df_na_hr$LogPreyBM<-log10(df_na_hr$PreyBM)


corvif(df_na_hr[,c(8,9)])


```

There is a weakly-increasing relationship between log handling times and log prey body mass, while the relationship with log predator body mass is weakly negative. The relationship between the response and temperature looks flat with loads of noise; however prey body mass (which we would expect to be more strongly correlated with handling times) is positive.

All VIF values are below 3 indicating no collinearity between these variables. However, I'm not convinced that the relationship with predator body mass is not because of collinearity.


Crawley (p.434) suggests tackling a multiple regression problem using non-parametric smoothers in a generalized additive model. 

```{r}
library (mgcv)
par(mfrow=c(2,2))

hr3<-gam(forage_db$L.Fittted.h..day.~s(forage_db$L.PreyBM)+s(forage_db$L.PredBM)+s(forage_db$Temp..C..))
plot(hr3)
par(mfrow=c(1,1))

anova(hr3)

summary(hr3)

```

Both predator and prey body masses are significant while Temperature is not.


```{r}

library(tree)

hr3_T<-tree(L.Fittted.h..day.~L.PreyBM+L.PredBM+Temp..C..,data=forage_db)
plot(hr3_T)
text(hr3_T)
```


Predator body mass is the predcitor variable for the primary split. Prey body mass is important at both high and low predator body mass. Temperature does not feature at al..



Handling time equivalency based on modelled intercept and slope values
---

Run tests assuming equivalency.

```{r echo=FALSE, fig.width=10, fig.height=5}

par(mfrow=c(1,2))

forage_db$L.PredictedPredBM<-(0.01598-0.02*forage_db$L.PreyBM)/0.03921
plot(forage_db$L.PredBM, forage_db$L.PredictedPredBM, xlab="Log 10 Preditor biomass", ylab="log 10 Predicted preditor biomass")
abline(lm(forage_db$L.PredictedPredBM~forage_db$L.PredBM),col="red")

forage_db$L.PredictedPreyBM<-(0.01598-0.03921*forage_db$L.PredBM)/0.02
plot(forage_db$L.PreyBM, forage_db$L.PredictedPreyBM, xlab="Log 10 Prey biomass", ylab="log 10 Predicted prey biomass")
abline(lm(forage_db$L.PredictedPreyBM~forage_db$L.PreyBM),col="red")

```


It looks like it's predicting ok around 0 but seriously underpredicting at low values and over predicting at high values (if I'm reading this correctly). So I would say not models are not equivalent as they stand now.

I'm going to generate some values for prey and predator body masses. Plug in slopes from the model and plot predictions against one another.


```{r}
hist(forage_db$L.PredBM)
summary(forage_db$L.PredBM)

LogPredBM<-na.omit(forage_db$L.PredBM)

sd(LogPredBM)
mean(LogPredBM)

#generate a log-normal distribution
L.predBM_sim<-rnorm(100000, mean=0.9776378, sd=2.481012)
hist(L.predBM_sim)
predBM_sim<-10^L.predBM_sim
hist(predBM_sim)

#Prey
LogPreyBM<-na.omit(forage_db$L.PreyBM)

sd(LogPreyBM)
mean(LogPreyBM)

#generate a (log) normal distibution
L.preyBM_sim<-rnorm(100000, mean=-1.098699, sd=2.594578)
hist(L.preyBM_sim)
preyBM_sim<-10^L.preyBM_sim
hist(preyBM_sim)

#prediction for model 1: M1
predM1<-0.632639*L.preyBM_sim-0.6179177*L.predBM_sim


#predcitions for model 2: M2
predM2<-0.627036*log10(preyBM_sim/predBM_sim)

plot(predM1,predM2)


```


18/02/2020

Arrhenius Temperature Dependence
---

I will next attempt a fit with temperature converted to Arrhenius temperature. This will involve converting temperature in Celsius to temp in Kelvin and adding Boltzmann constant *k* (=8.617x10-5 eVK]. This should allow us to estimate the activation energy *Eh* and *Ea* describing the (exponential) increase in the metabolism with temperature.




Let's have a qucik look at the relationships again.

```{r echo=FALSE,fig.width=10, fig.height=10}

#MG TO GRAM
forage_db$Predator.mass.g.<-forage_db$Predator.mass..mg./1000
forage_db$Prey.mass.g.<-forage_db$Prey.mass..mg./1000

#I'll convert body masses and rates to NATURAL locarithms.

#reduce data set to the variables we're interested in. 
forage_db$L.PredBM<-log(forage_db$Predator.mass.g.)
forage_db$L.PreyBM<-log(forage_db$Prey.mass.g.)
forage_db$L.Fitted.a..median.of.BS.samples.<-log(forage_db$Fitted.a..median.of.BS.samples.)
forage_db$L.Fittted.h..day.<-log(forage_db$Fittted.h..day.)


#add ecto and endotherms
forage_db$EctoEndo<-ifelse(forage_db$Major.grouping.1=="Bird" | forage_db$Major.grouping.1=="Mammal", "Endo", "Ecto" )

#I'll remove angiosperms, protozoans and Nas.


forage_db<-forage_db[forage_db$Vert.invert!="" & forage_db$Vert.invert!="Angiosperm" ,]
table(forage_db$Vert.invert)
#& forage_db$Vert.invert!="Protozoan"


```


```{r echo=FALSE}


#deduct To = 293.15K

To<-293.15

#devide by *kTTo
k<-0.00008617

#convert
forage_db$temp_K<-forage_db$Temp..C..+273.15
forage_db$temp_A<-(forage_db$temp_K-To)/(k*forage_db$temp_K*To)




#plot

#pairs(forage_db[,c(50,51,53, 49, 48)], panel=panel.smooth)

```

**Arrhenius - Attack Rates**


```{r echo=FALSE}


df<-cbind(as.numeric(forage_db$L.PredBM), as.numeric(forage_db$L.PreyBM), as.numeric(forage_db$L.Fitted.a..median.of.BS.samples.), as.numeric(forage_db$L.Fittted.h..day.), as.numeric(forage_db$temp_A))

#colnames(df)<-c("LogPredBM", "LogPreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c")
colnames(df)<-c("L.PredBM", "L.PreyBM", "L.Fitted.a..median.of.BS.samples.", "L.Fittted.h..day.", "temp_A")

df<-as.data.frame(df)


df$Habitat<-forage_db$Habitat
#add ecto and endotherms
forage_db$EctoEndo<-ifelse(forage_db$Major.grouping.1=="Bird" | forage_db$Major.grouping.1=="Mammal", "Endo", "Ecto" )

#I'll remove angiosperms, protozoans and Nas.

forage_db<-forage_db[forage_db$Vert.invert!="" & forage_db$Vert.invert!="Angiosperm" ,]
table(forage_db$Vert.invert)

df<-as.data.frame(df)

df$VertInvert<-forage_db$Vert.invert
df$EctoEndo<-forage_db$EctoEndo


df_no<-df[df$VertInvert!="" & df$VertInvert!="Angiosperm",]
table(df_no$VertInvert, df_no$EctoEndo)

df_na<-na.omit(df_no)
df_na<-subset(df_na, df_na[,5]!="-Inf")

```

```{r}

ar3<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+L.PreyBM+temp_A, data=df)

summary(ar3)
anova(ar3)

step(ar3)
drop1(ar3)

```



```{r echo=FALSE,fig.height=10, fig.width=10}

op<-par(mfrow=c(2,2))

#win.graph();
op<-par(mfrow=c(2,2))
plot(ar3)
#Check for normality
E<-rstandard(ar3)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=df_na$L.PredBM, xlab="Ln Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na$temp_A, xlab="Temp, Arrhenius", ylab="Residuals")
abline(0,0)

#Residuals against Prey Bodymass
plot(E~df_na$L.PreyBM, xlab="Ln Prey bodymass", ylab="Residuals")
abline(0,0)
par(op)

```

I'm going to drop prey body mass and refit with predator and temp.


```{r echo=FALSE,fig.height=10, fig.width=10}

ar3_opt<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+temp_A, data=df)
summary(ar3_opt)

op<-par(mfrow=c(2,2))

#win.graph();
plot(ar3_opt)
#Check for normality
E<-rstandard(ar3_opt)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=df_na$L.PredBM, xlab="Ln Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na$temp_A, xlab="Temp, Arrhenius", ylab="Residuals")
abline(0,0)

#Residuals against Prey Bodymass
plot(E~df_na$L.PreyBM, xlab="Ln Prey bodymass", ylab="Residuals")
abline(0,0)
par(op)
```



```{r echo=FALSE,fig.width=10, fig.height=10}
df_na<-df[,c(1,3,5)]
df_na<-na.omit(df_na)
#summary(df_sSet_Terr_na)

ar3_opt_na<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+temp_A, data=df_na)


ggPredict(ar3_opt_na, interactive = TRUE)

```

```{r eval=FALSE}

df_inf<-subset(forage_db, forage_db[,52]!="-Inf")

ar3_opt_inf<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+temp_A, data=df_inf)


summary(ar3_opt_inf)

```

**Ln(Attack Rate)=0.85X+(-7.01+0.90 per Arrhenius term), where X=Ln Predator Body mass** in MG.

**Ln(Attach Rate)= 0.85x+(-1.13+0.90 Temp_A), where x=Ln Predator body mass ** in GRAM.

So, the activcation energy of attack rate for the full model is *Ea* = 1.06.


06/04/2020

With Habitats
---

Process data line 1005.

```{r echo=FALSE,fig.width=10, fig.height=10}

#I'm goint to remove mixed
df<-df[df$Habitat!="Mixed",]

table(df$Habitat)
head(df)


plot(df$L.Fitted.a..median.of.BS.samples.~df$Habitat)


summary(aov(df$L.Fitted.a..median.of.BS.samples.~df$Habitat))

```



```{r echo=FALSE}
#let's check the assumptions of teh model
op<-par(mfrow=c(2,2))
plot(aov(df$L.Fitted.a..median.of.BS.samples.~df$Habitat))

##effect sizes
model<-aov(df$L.Fitted.a..median.of.BS.samples.~df$Habitat)
model.tables(model, se=T)

summary.lm(model)

```



Unlike handling times , attack rates do not differ significantly between habitats.

Most validation plots are  ok except for normality that is highly skewed on both ends.

Let's have a look at some EDA plots.

```{r echo =FALSE}
par(mfrow=c(1,1))
attach(df)
#Let's try the simplest model first: Prey*Habitat
plot(L.PredBM,L.Fitted.a..median.of.BS.samples., pch=16, col=c("blue", "red")[as.numeric(Habitat)])


#levels(df_sSet$Habitat)

abline(lm(L.Fitted.a..median.of.BS.samples.[Habitat=="Aquatic"]~L.PredBM[Habitat=="Aquatic"]), col="blue")
abline(lm(L.Fitted.a..median.of.BS.samples.[Habitat=="Terrestrial"]~L.PredBM[Habitat=="Terrestrial"]), col="red")

ggplot(df,aes(L.PredBM,L.Fitted.a..median.of.BS.samples., col=Habitat))+geom_point()
```


Lines intersect though theris a slight difference in slope and intercept (terrestrial slightly more shallow and higher intercept).

I'll try the maximal model.

```{r echo=FALSE}

m1<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM*L.PreyBM*temp_A*Habitat, data=df)
summary(m1)

m2<-update(m1,~ . -L.PreyBM:Habitat)
summary(m2)

m3<-update(m2,~. -temp_A:Habitat)
summary(m3)

m4<-update(m3,~. -L.PreyBM:temp_A:Habitat)
summary(m4)

m5<-update(m4,~.-L.PredBM:temp_A)
summary(m5)

m6<-update(m5,~.-L.PredBM:L.PreyBM:Habitat)
summary(m6)

step(m1)

drop1(m1)

op<-par(mfrow=c(2,2))

plot(m6)


```


This model includes 3 and 4-way interactions adn is too complex to be practical so I'll just re-fit for the two habitats. THe fits are not the greatest either.

**Ectotherms vs Endotherms** (15/04/2020)

```{r echo=FALSE}

df$EctoEndo<-as.factor(df$EctoEndo)

plot(df$L.Fitted.a..median.of.BS.samples.~df$EctoEndo)


summary(aov(df$L.Fitted.a..median.of.BS.samples.~df$EctoEndo))

```

Attack rates for endotherms are significantly higher than for ectotherms.

```{r echo=FALSE,fig.width=10, fig.height=10}

e1<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM*L.PreyBM*temp_A*EctoEndo, data=df)
summary(e1)

e2<-update(e1,~.-L.PredBM:L.PreyBM:temp_A:EctoEndo)
summary(e2)

e3<-update(e2,~.-L.PreyBM:temp_A:EctoEndo)
summary(e3)

e4<-update(e3, ~. -L.PredBM:EctoEndo)
summary(e4)

e5<-update(e4,~. -L.PreyBM)
summary(e5)

e6<-update(e5,~. -L.PredBM:L.PreyBM)
summary(e6)

e7<-update(e6, ~. -EctoEndo)
summary(e7)

e8<-update(e7, ~. -L.PreyBM:EctoEndo)
summary(e8)


#drop1(e1)

op<-par(mfrow=c(2,2))

plot(e8)

```

If fitted together, we end with a complex model that includes 2- and 3-way interactions. 

The model is not brilliant but not the worst I've seen.


**Ectotherms**

Interactive:

```{r echo=FALSE,fig.width=10, fig.height=10}


detach(df)

df_Ecto<-df[df$EctoEndo=="Ecto",]

ec1<-lm(df_Ecto$L.Fitted.a..median.of.BS.samples.~df_Ecto$L.PredBM*df_Ecto$L.PreyBM*df_Ecto$temp_A)
summary(ec1)

#delete interaction
ec2<-update(ec1,~.-df_Ecto$L.PredBM:df_Ecto$L.PreyBM)
summary(ec2)

ec3<-update(ec2, ~.-df_Ecto$L.PreyBM)
summary(ec3)

op<-par(mfrow=c(2,2))
plot(ec3)

```

The model inlcudes 2- and 3-way interactions. Fit is ok.

Additive:

```{r echo=FALSE,fig.width=10, fig.height=10}


ec4<-lm(df_Ecto$L.Fitted.a..median.of.BS.samples.~df_Ecto$L.PredBM+df_Ecto$L.PreyBM+df_Ecto$temp_A)
summary(ec4)


ec5<-update(ec4, ~.-df_Ecto$L.PreyBM)
summary(ec5)

op<-par(mfrow=c(2,2))
plot(ec5)

#table(df$Habitat,df$EctoEndo)

```

```{r echo=FALSE,fig.width=10, fig.height=10}
df_Ecto_na<-df_Ecto[,c(1,3,5)]
df_Ecto_na<-na.omit(df_Ecto_na)
#summary(df_sSet_Terr_na)

ec5_na<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+temp_A, data=df_Ecto_na)

ggPredict(ec5_na, interactive = TRUE)


```


**Endotherms**

Interactive


```{r echo=FALSE,fig.width=10, fig.height=10}


df_Endo<-df[df$EctoEndo=="Endo",]

ed1<-lm(df_Endo$L.Fitted.a..median.of.BS.samples.~df_Endo$L.PredBM*df_Endo$L.PreyBM*df_Endo$temp_A)
summary(ed1)

#delete interaction
ed2<-update(ed1,~.-df_Endo$L.PredBM:df_Endo$L.PreyBM:df_Endo$temp_A)
summary(ed2)

ed3<-update(ed2, ~.-df_Endo$L.PreyBM:df_Endo$temp_A)
summary(ed3)



#Abandoned - no significant terns

```


Additive

```{r echo=FALSE,fig.width=10, fig.height=10}


ed4<-lm(df_Endo$L.Fitted.a..median.of.BS.samples.~df_Endo$L.PredBM+df_Endo$L.PreyBM+df_Endo$temp_A)
summary(ed4)

#delete interaction
ed5<-update(ed4,~.-df_Endo$L.PredBM)
summary(ed5)

ed3<-update(ed2, ~.-df_Endo$L.PreyBM:df_Endo$temp_A)
summary(ed3)


```


1. Terrestrial:
---

```{r echo=FALSE,fig.width=10, fig.height=10}



df_Terr<-df[df$Habitat=="Terrestrial",]

m1_terr<-lm(df_Terr$L.Fitted.a..median.of.BS.samples.~df_Terr$L.PredBM*df_Terr$L.PreyBM*df_Terr$temp_A)
summary(m1_terr)

#delete interaction
m2_terr<-update(m1_terr,~.-df_Terr$L.PredBM:df_Terr$L.PreyBM)
summary(m2_terr)

m3_terr<-update(m2_terr, ~.-df_Terr$L.PreyBM:df_Terr$temp_A)
summary(m3_terr)

m4_terr<-update(m3_terr,~.-df_Terr$L.PreyBM)
summary(m4_terr)

anova(m4_terr)
drop1(m4_terr)

op<-par(mfrow=c(2,2))
plot(m4_terr)

```

The model's fit is truly terrible. The model includes Pred:Temp and a 3-way Pred:Prey:Temp interaction.

Let's try a simpler model.

```{r echo=FALSE,fig.width=10, fig.height=10}

m5_terr<-lm(df_Terr$L.Fitted.a..median.of.BS.samples.~df_Terr$L.PredBM+df_Terr$L.PreyBM+df_Terr$temp_A)

summary(m5_terr)
drop1(m5_terr)

op<-par(mfrow=c(2,2))
plot(m5_terr)

#try to remove prey body mass
m6_terr<-update(m5_terr,~. -df_Terr$L.PreyBM)
summary(m6_terr)
plot(m6_terr)

#anova(m5_terr,m6_terr)

```

Removing prey BM increases BM from 1368  to 1373. Optimal for terrestrial, Prey bodymass is significant at 0.001 (p=0.007). Intercept is significant at 0.001(p=0.005).

The optimal is **L.Fitted.a..median.of.BS.samples. ~ L.PredBM +L.PreyBM +temp_A**. 

However, the model is rearly poor with a lot of trends and skew.


Without prey body mass the model for terrestrial is : **Th=0.75x+(-1.48+0.58xTemp_A)**.


```{r echo=FALSE,fig.width=10, fig.height=10}
df_Terr_na<-df_Terr[,c(1,3,5)]
df_Terr_na<-na.omit(df_Terr_na)
#summary(df_sSet_Terr_na)

m6_terr_na<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+temp_A, data=df_Terr_na)

ggPredict(m6_terr_na, interactive = TRUE)


```



**Ectotherms vs Endotherms**

*Ectotherms*

```{r echo=FALSE,fig.width=10, fig.height=10}


df_Terr_Ecto<-df_Terr[df_Terr$EctoEndo=="Ecto",]

ec1_terr<-lm(df_Terr_Ecto$L.Fitted.a..median.of.BS.samples.~df_Terr_Ecto$L.PredBM*df_Terr_Ecto$L.PreyBM*df_Terr_Ecto$temp_A)
summary(ec1_terr)

#delete interaction
ec2_terr<-update(ec1_terr,~.-df_Terr_Ecto$L.PredBM:df_Terr_Ecto$L.PreyBM:df_Terr_Ecto$temp_A)
summary(ec2_terr)

ec3_terr<-update(ec2_terr, ~.-df_Terr_Ecto$L.PredBM:df_Terr_Ecto$L.PreyBM)
summary(ec3_terr)

ec4_terr<-update(ec3_terr, ~.-df_Terr_Ecto$L.PreyBM)
summary(ec4_terr)

ec5_terr<-update(ec4_terr,~. -df_Terr_Ecto$L.PredBM:df_Terr_Ecto$temp_A)
summary(ec5_terr)

op<-par(mfrow=c(2,2))
plot(ec5_terr)


```


The model includes a couple of 2-way and 3-way interactions..The fit is not the best but not too horrible.


Try an additive model.


```{r echo=FALSE,fig.width=10, fig.height=10}

ec6_terr<-lm(df_Terr_Ecto$L.Fitted.a..median.of.BS.samples.~df_Terr_Ecto$L.PredBM+df_Terr_Ecto$L.PreyBM+df_Terr_Ecto$temp_A)

summary(ec6_terr)

drop1(ec6_terr)


op<-par(mfrow=c(2,2))


#try to remove prey body mass
ec7_terr<-update(ec6_terr,~. -df_Terr_Ecto$L.PreyBM)
summary(ec7_terr)
plot(ec7_terr)


df_Terr_ecto_na<-df_Terr_Ecto[,c(1,3,5)]
df_Terr_ecto_na<-na.omit(df_Terr_ecto_na)
#summary(df_sSet_Terr_na)

ec7_terr_na<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+temp_A, data=df_Terr_ecto_na)

op<-par(mfrow=c(1,1))
ggPredict(ec7_terr_na, interactive = TRUE)

#anova(m5_terr,m6_terr)

```

*Endotherms*

```{r echo=FALSE,fig.width=10, fig.height=10}


df_Terr_Endo<-df_Terr[df_Terr$EctoEndo=="Endo",]

ed1_terr<-lm(df_Terr_Endo$L.Fitted.a..median.of.BS.samples.~df_Terr_Endo$L.PredBM*df_Terr_Endo$L.PreyBM*df_Terr_Endo$temp_A)
summary(ed1_terr)

#delete interaction
ed2_terr<-update(ed1_terr,~.-df_Terr_Endo$L.PredBM:df_Terr_Endo$L.PreyBM:df_Terr_Endo$temp_A)
summary(ed2_terr)

ed3_terr<-update(ed2_terr, ~.-df_Terr_Endo$L.PreyBM:df_Terr_Endo$temp_A)
summary(ed3_terr)

ed4_terr<-update(ed3_terr,~.-df_Terr_Endo$L.PredBM:df_Terr_Endo$temp_A)
summary(ed4_terr)

ed5_terr<-update(ed4_terr,~.-df_Terr_Endo$L.PredBM:df_Terr_Endo$L.PreyBM)
summary(ed5_terr)


op<-par(mfrow=c(2,2))
#plot(ed_terr)


```


The model includes a couple of 2-way and 3-way interactions..The fit is not the best but not too horrible.


Try an additive model.


```{r echo=FALSE,fig.width=10, fig.height=10}

ec4_terr<-lm(df_Terr_Ecto$L.Fitted.a..median.of.BS.samples.~df_Terr_Ecto$L.PredBM+df_Terr_Ecto$L.PreyBM+df_Terr_Ecto$temp_A)

summary(ec4_terr)

ec5_terr<-update(ec4_terr, ~.-df_Terr_Ecto$L.PreyBM)
summary(ec5_terr)

op<-par(mfrow=c(2,2))
plot(m5_terr)

#try to remove prey body mass
m6_terr<-update(m5_terr,~. -df_Terr$L.PreyBM)
summary(m6_terr)
plot(m6_terr)

#anova(m5_terr,m6_terr)

```



Aquatic:
---


```{r echo=FALSE,fig.width=10, fig.height=10}


df_Aq<-df[df$Habitat=="Aquatic",]

m1_aq<-lm(df_Aq$L.Fitted.a..median.of.BS.samples.~df_Aq$L.PredBM*df_Aq$L.PreyBM*df_Aq$temp_A)
summary(m1_aq)

#delete interaction
m2_aq<-update(m1_aq,~.-df_Aq$L.PredBM:df_Aq$temp_A)
summary(m2_aq)

m3_aq<-update(m2_aq, ~.-df_Aq$L.PreyBM)
summary(m3_aq)

#m4_aq<-update(m3_aq, ~. -df_Aq$L.PreyBM)
#summary(m4_aq)


anova(m3_aq)
drop1(m3_aq)

op<-par(mfrow=c(2,2))
plot(m3_aq)


m5_aq<-update(m3_aq, ~. -df_Aq$L.PredBM:df_Aq$temp_A:df_Aq$L.PreyBM)
summary(m5_aq)


m6_aq<-update(m5_aq, ~.-df_Aq$temp_A:df_Aq$L.PreyBM)
summary(m6_aq)

m7_aq<-update(m6_aq,~.-df_Aq$L.PredBM:df_Aq$L.PreyBM)
summary(m7_aq)

#anova(m7_aq,m3_aq)
plot(m7_aq)
```

Aquatic model is reasonably well-behaved. 

**lnTh=0.88x-1+1.08Temp_A**

Let's try a simpler model.

```{r echo=FALSE,fig.width=10, fig.height=10, eval=FALSE}

m8_aq<-lm(df_Aq$L.Fitted.a..median.of.BS.samples.~df_Aq$L.PredBM+df_Aq$L.PreyBM+df_Aq$temp_A)

summary(m8_aq)

m9_aq<-update(m8_aq,~.-df_Aq$L.PreyBM)
summary(m9_aq)

op<-par(mfrow=c(2,2))
plot(m7_aq)

```

```{r echo=FALSE,fig.width=7, fig.height=10}
df_Aq_na<-df_Aq[,c(1,3,5)]
df_Aq_na<-na.omit(df_Aq_na)
#summary(df_sSet_Terr_na)

m7_aq_na<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+temp_A, data=df_Aq_na)

ggPredict(m7_aq_na, interactive = TRUE)


```
