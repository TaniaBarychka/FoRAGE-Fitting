---
title: "Forage Fitting"
author: "Tania Barychka"
date: "17/01/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

**Summary from data exploration**

1. Possible outliers in covariates and responses except for the Temperature.
2. Signs of collenarity between prey and predator body masses.
3. Relationships:
- Handling times increases with prey body mass particucarly for invertebrates and vertebrates. Not as clear for protozoans.
Handling time increases more clearly with Prey/Predator bosy mass and slope looks more similar between groups.
No clear relationship with predator body mass.
- Attack rates increase with both prey and predator body masses.
- No clear relationships with temperature.
4.  No significant interactions with temperature only. Some signs of interactions when broken into groups.


I will start with simple models with no interactions.

Consider residuals.

Consider interaction with temperature.

Apply the model, model selection, model validation. If the validation shows that there are patterns in the residuals, I will investigate why. Adding interactions may be an option to improve the model.

```{r echo=FALSE, warning=FALSE, message=FALSE}

library (ggplot2)
library(dplyr)          # for data manipulation
library(tidyr)          # for data shaping
library(ggpubr)
library(gridExtra)
library(car)
library(lattice)

install.packages("devtools")
devtools::install_github("cardiomoon/ggiraphExtra")
require(ggiraph)
require(ggiraphExtra)
require(plyr)


#work desktop
source("C:/Users/Tania Barychka/OneDrive/Desktop/HighstatLibV10.R")

#home desktop
#source("C:/Users/Etherian/OneDrive/Desktop/HighstatLibV10.R")

# Create customized color palette
library(RColorBrewer)
mycol = c(brewer.pal(name="Dark2", n = 8), brewer.pal(name="Paired", n = 6))
```



```{r echo=FALSE}
#work
forage_db<- read.csv("C:/Users/Tania Barychka/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

#summary(forage_db)


#home
#forage_db<- read.csv("C:/Users/Etherian/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

#laptop
#forage_db<- read.csv("C:/Users/Tania/OneDrive/Documents/Madingley Postdoc/resource_map_doi_10_5063_F17H1GTQ/data/FoRAGE_db_12_19_18_data_set.csv")

forage_db<-forage_db[-c(2084:2682),]

#reduce data set to the variables we're interested in. 
forage_db$L.PredBM<-log10(forage_db$Predator.mass..mg.)
forage_db$L.PreyBM<-log10(forage_db$Prey.mass..mg.)
forage_db$L.Fitted.a..median.of.BS.samples.<-log10(forage_db$Fitted.a..median.of.BS.samples.)
forage_db$L.Fittted.h..day.<-log10(forage_db$Fittted.h..day.)

#add ecto and endotherms
forage_db$EctoEndo<-ifelse(forage_db$Major.grouping.1=="Bird" | forage_db$Major.grouping.1=="Mammal", "Endo", "Ecto" )

#I'll remove angiosperms, protozoans and Nas.

forage_db<-forage_db[forage_db$Vert.invert!="" & forage_db$Vert.invert!="Angiosperm" ,]
table(forage_db$Vert.invert)
#& forage_db$Vert.invert!="Protozoan"

```


```{r eval=FALSE, echo=FALSE}


df<-cbind(forage_db$L.PredBM, forage_db$L.PreyBM, forage_db$L.Fitted.a..median.of.BS.samples., forage_db$L.Fittted.h..day., forage_db$Temp..C.., forage_db$EctoEndo)

colnames(df)<-c("LogPredBM", "LogPreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c", "EctoEndo")

df<-as.data.frame(df)

df$VertInvert<-forage_db$Vert.invert


df_no<-df[df$VertInvert!="" & df$VertInvert!="Angiosperm",]
table(df_no$VertInvert, df_no$EctoEndo)

```


A. Attack rate
--


```{r}

#Attack rate ~ Predator body mass
ar1_pred<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM)
summary(ar1_pred)
anova(ar1_pred)

#Attack rate ~Prey body mass
ar1_prey<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PreyBM)
summary(ar1_prey)
anova(ar1_prey)

#Attack rate ~Prey and Pred Body mass
ar1_preyPred<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM+forage_db$L.PreyBM)
summary(ar1_preyPred)
anova(ar1_preyPred)

#run a drop test
drop1(ar1_preyPred, test="F")
```

AIC and the residual sum of squares of the model with prey body mass is just slightly smaller. Will keep prey body mass for now.

Let's look at potential interaction with temperature.


```{r}
ar1_preyPredTemp<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM+forage_db$L.PreyBM+forage_db$Temp..C..)
summary(ar1_preyPredTemp)
anova(ar1_preyPredTemp)
drop1(ar1_preyPredTemp)

#Fit a model with predator BM and compare
#ar1_predTemp<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM+forage_db$Temp..C..)
#anova(ar1_preyPredTemp, ar1_predTemp)

```

*Model Selection*

```{r}

step(ar1_preyPredTemp)
```

Sadly, I cant compare models directly as the number of non-na datapoints vary between cases.

```{r}

df<-cbind(as.numeric(forage_db$L.PredBM), as.numeric(forage_db$L.PreyBM), as.numeric(forage_db$L.Fitted.a..median.of.BS.samples.), as.numeric(forage_db$L.Fittted.h..day.), as.numeric(forage_db$Temp..C..))

#colnames(df)<-c("LogPredBM", "LogPreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c")
colnames(df)<-c("L.PredBM", "L.PreyBM", "L.Fitted.a..median.of.BS.samples.", "L.Fittted.h..day.", "Temp..C..")


df<-as.data.frame(df)

df$VertInvert<-forage_db$Vert.invert
df$EctoEndo<-forage_db$EctoEndo


df_no<-df[df$VertInvert!="" & df$VertInvert!="Angiosperm",]
table(df_no$VertInvert, df_no$EctoEndo)

df_na<-na.omit(df_no)

ar1_preyPredTemp_na<-lm(df_na$LogFittedAR~df_na$LogPredBM+df_na$LogPreyBM+df_na$Temp_c)

step(ar1_preyPredTemp_na)

#Optimal: AR~Predator BM + Temp
ar1_opt_f<-lm(forage_db$L.Fitted.a..median.of.BS.samples.~forage_db$L.PredBM+forage_db$Temp..C..)

summary(ar1_opt_f)
anova(ar1_opt_f)

```

It looks like the model with Predator body mass and temperature is very marginally better than the full model (Prey and predator body mass and temp) withou Nas removed. 

Step selection (with Na's removed from dataset) suggest that that full model is very slightly better (AIC of 909.32) compared to the model without Prey biomass (AIC = 910.54). Removal of temperature and predator biomass increase AICs to 1026.64 and 1803.60, respectively.


*Model Validation*

I'm going to proceed with predator body mass and temperature only.

1. Plot (standardised) residuals against fitted values to assess homogeneity.
2. Make a histogram of teh residuals to verify normality. Can also use QQ-plot.
3. Plot the residuals against each  explanatory variable. If there is a pattern, we're violating the independence assumption.
Plot the residuals against prey bodymass (not used in the model). If there is a patter, include prey body mass and refit the model. If the residuals patterms disappear, include prey body mass (even of not significant)
4. Assess the model for influential observations. A useful tool is the Cook distance function.


```{r fig.height=10, fig.width=10}

ar1_opt<-lm(df_na$L.Fitted.a..median.of.BS.samples.~df_na$L.PredBM+df_na$Temp..C..)

op<-par(mfrow=c(2,2))



#win.graph();
op<-par(mfrow=c(2,2))
#Check for normality
E<-rstandard(ar1_opt)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=df_na$L.PredBM, xlab="log10 Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na$Temp..C.., xlab="Temp, C", ylab="Residuals")
abline(0,0)

#Residuals against Prey Bodymass
plot(E~df_na$L.PreyBM, xlab="Prey bodymass", ylab="Residuals")
abline(0,0)
par(op)
```

1. There is some evidence of non-constant variance as points are clustered in the middle, and of uniform errors (S-shaped pattern in QQ plot: the fit in the centre is fine, but the largest and the smallest residuals are too small).

2. A bit of clustering for fitted values vs square root of standardised residuals. But not too bad.

3. We have three influential points that need investigating: 172; 374 (?) and 375 (?).We will leave them out and refit the model (p402); check the new slope and the standard error on the slope.

4. I can't see a strong pattern in residuals vs explanatory variables plot including prey bodymass. I'm going to leave it out for now.

*As errors are unform, we may need to fit a different model to the data.* Spoke to Tim and he felt that test looked alright, no big issues.



```{r echo=FALSE, eval=FALSE}

m1<-lm(LogFittedAR~LogPreyBM+LogPredBM+Temp_c, data=df_no)
summary(m1)

drop1(m1,test="F")

anova(m1)

step(m1)

```


**Interaction Models**

```{r}

ar2_PredTempE<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+Temp..C..*as.factor(EctoEndo), data=forage_db)
summary(ar2_PredTempE)
anova(ar2_PredTempE)

drop1(ar2_PredTempE)

step(ar2_PredTempE)

```

Predator Body mass and temperature still highly significant on their own. Ecto and Endotherm are not significant on their own but are significant at 5% as an inetraction with temperature.

AIC of the full model is very marginally smaller (1198.6) than the model with the interaction between temperature and Ecto/Endo (1202.4) 

How do models with and without Temperature- Ecto/Endo interaction compare?


```{r}

ar1_opt_na<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+df_na$Temp..C.., data=df_na)
summary(ar1_opt_na)

ar2_PredTempE_na<-lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+df_na$Temp..C..*as.factor(EctoEndo), data=df_na)
summary(ar1_opt_na)

anova(ar1_opt_na, ar2_PredTempE_na)
```

Comparing models using anova suggests including the interaction term led to significantly (<.001) improved fit. Two addtional parameters are estimated in more complex model.

Let's do **model validation** again.


```{r echo=FALSE}
op<-par(mfrow=c(2,2))

plot(ar2_PredTempE_na)


#win.graph();

#Check for normality
E<-rstandard(ar2_PredTempE_na)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=df_na$L.PredBM, xlab="log10 Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na$Temp..C.., xlab="Temp, C", ylab="Residuals")
abline(0,0)

#Residuals against Prey Bodymass
plot(E~df_na$L.PreyBM, xlab="Prey bodymass", ylab="Residuals")
abline(0,0)
par(op)
```


Model validation for the model with inetraction term looks about the same as the model without the interaction term: no serious issues.


**Predictions**

```{r fig.height=10, fig.width=10}

newLpredBM=df_na$L.PredBM
newTemp=df_na$Temp..C..

newdata<-data.frame(newLpredBM=df_na$L.PredBM,newTemp=df_na$Temp..C..)


ar1_opt_na=lm(L.Fitted.a..median.of.BS.samples.~L.PredBM+Temp..C.., data=df_na)
summary(ar1_opt_na)

#pred<-predict.lm(ar1_opt_na, newdata)
#plot(L.PredBM, L.Fitted.a..median.of.BS.samples., data=)
#points(pred, df_na$L.PredBM, col="blue")


#ggplot(df_na, aes(df_na$L.PredBM,df_na$L.Fitted.a..median.of.BS.samples., colour=df_na$Temp..C..))+geom_point()+stat_smooth(method="lm", se=FALSE)


ggPredict(ar1_opt_na, interactive = TRUE)


```


Predictions of the current model are over-predicting the data. Look at the model with interaction: hopefully it'd be a better fit. Also possibly prey biomass...

B. Handling time
--


```{r echo=FALSE, eval=FALSE}

#Handling time ~ Predator Body mass+Prey Body Mass+Temp_c

m2<-lm(LogFittedH_day~LogPreyBM+LogPredBM+Temp_c, data=df_no)
summary(m2)

drop1(m2,test="F")

anova(m2)

```



```{r echo=FALSE, eval=FALSE}
#Handling time ~ Prey/Predator body mass+Temp

m3<-lm(log10(Fittted.h..day.)~log10(Prey.mass..mg./Predator.mass..mg.)+Temp..C.., data=forage_db)
summary(m3)

drop1(m3,test="F")

anova(m3)

anova(m2,m3)
```


```{r}

#prey
ht1_prey<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM)
summary(ht1_prey)
anova(ht1_prey)

#predator
ht1_pred<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PredBM)
summary(ht1_pred)
anova(ht1_pred)

#prey/predator
ht1_preyOverpred<-lm(log10(Fittted.h..day.)~log10(Prey.mass..mg./Predator.mass..mg.), data=forage_db)
summary(ht1_preyOverpred)
anova(ht1_preyOverpred)

#prey and pred
ht1_preyPred<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM+forage_db$L.PredBM)
summary(ht1_preyPred)
anova(ht1_preyPred)

drop1(ht1_preyPred)

```

The model with both predator and prey biomass has the lowest AIC score.

```{r}
#prey, pred and temp
ht1_preyPredTemp<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM+forage_db$L.PredBM+forage_db$Temp..C..)
summary(ht1_preyPredTemp)
anova(ht1_preyPredTemp)
drop1(ht1_preyPredTemp)

#prey/pred+Temp
ht1_preyOverpredTemp<-lm(log10(Fittted.h..day.)~log10(Prey.mass..mg./Predator.mass..mg.)+forage_db$Temp..C.., data=forage_db)
summary(ht1_preyOverpredTemp)
anova(ht1_preyOverpredTemp)

drop1(ht1_preyOverpredTemp)

#prey, Temp, pred
ht1_preyTempPred<-lm(forage_db$L.Fittted.h..day.~forage_db$L.PreyBM+forage_db$Temp..C..+forage_db$L.PredBM)
summary(ht1_preyTempPred)
```

At the moment, both predator and prey body mass are significant.The best model is harvest rate~prey/predator bodymass.

Temperature is not significant on its own. Perhaps as an interaction term? 

I'll also have a look at Ecto Endo grouping.

**Model validation**

```{r}

df_hr<-cbind(as.numeric(forage_db$Predator.mass..mg.), as.numeric(forage_db$Prey.mass..mg.), as.numeric(forage_db$L.Fitted.a..median.of.BS.samples.), as.numeric(forage_db$L.Fittted.h..day.), as.numeric(forage_db$Temp..C..))

colnames(df_hr)<-c("PredBM", "PreyBM", "LogFittedAR", "LogFittedH_day", "Temp_c")

df_hr<-as.data.frame(df_hr)

df_hr$VertInvert<-forage_db$Vert.invert
df_hr$EctoEndo<-forage_db$EctoEndo


df_no_hr<-df_hr[df_hr$VertInvert!="" & df_hr$VertInvert!="Angiosperm",]
table(df_no_hr$VertInvert, df_no_hr$EctoEndo)

df_na_hr<-na.omit(df_no_hr)
```



```{r fig.height=10, fig.width=10}

hr1_opt<-lm(df_na_hr$LogFittedH_day~log10(df_na_hr$PreyBM/df_na_hr$PredBM))
op<-par(mfrow=c(2,2))

plot(hr1_opt)


#win.graph();
op<-par(mfrow=c(2,2))
#Check for normality
E<-rstandard(hr1_opt)

hist(E)
qqnorm(E)

#check for independence and homogeneity: residuals versus individual explanatory variables
plot(y=E, x=log10(df_na_hr$PreyBM/df_na_hr$PredBM), xlab="log10 Prey/Predator bodymass", ylab="Residuals")
abline(0,0)

#Residuals against Temp
plot(E~df_na_hr$Temp_c, xlab="Temp, C", ylab="Residuals")
abline(0,0)

#Residuals against Prey Bodymass
plot(E~log10(df_na_hr$PreyBM), xlab="Prey bodymass", ylab="Residuals")
abline(0,0)


#Residuals against predator bodymass
plot(E~log10(df_na_hr$PredBM), xlab="Predator bodymass", ylab="Residuals")
abline(0,0)

plot(E~as.factor(df_na_hr$EctoEndo), ylab="Residuals")
par(op)

```


Some serious problems with the fits: missed variance structure or an explanatory variable.


**Residuals as function of ectotherms and endotherms:**

```{r echo=FALSE}

par(mfrow=c(1,2))


xyplot(E~Temp_c,groups=df_na_hr$EctoEndo, data = df_na_hr,auto.key = list(corner = c(0, .98)), cex = 1,xlab="Temp, C", ylab="Residuals",panel = function(x, y, ...){
        
          panel.xyplot(x,y, ...)
          panel.abline(h=0,lty=1,lwd=1)
        })


```




**Handling time equivalency based on modelled intercept and slope values**

Run tests assuming equivalency.

```{r echo=FALSE, fig.width=10, fig.height=5}

par(mfrow=c(1,2))

forage_db$L.PredictedPredBM<-(0.01598-0.02*forage_db$L.PreyBM)/0.03921
plot(forage_db$L.PredBM, forage_db$L.PredictedPredBM, xlab="Log 10 Preditor biomass", ylab="log 10 Predicted preditor biomass")
abline(lm(forage_db$L.PredictedPredBM~forage_db$L.PredBM),col="red")

forage_db$L.PredictedPreyBM<-(0.01598-0.03921*forage_db$L.PredBM)/0.02
plot(forage_db$L.PreyBM, forage_db$L.PredictedPreyBM, xlab="Log 10 Prey biomass", ylab="log 10 Predicted prey biomass")
abline(lm(forage_db$L.PredictedPreyBM~forage_db$L.PreyBM),col="red")

```


It looks like it's predicting ok around 0 but seriously underpredicting at low values and over predicting at high values (if I'm reading this correctly). So I would say not models are not equivalent as they stand now.

